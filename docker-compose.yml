services:
  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:stable
    container_name: ib-gateway
    restart: unless-stopped
    labels:
      autoheal: "true"  # Enable autoheal to restart on unhealthy
    environment:
      - TWS_USERID=${IB_USERNAME}
      - TWS_PASSWORD=${IB_PASSWORD}
      - TRADING_MODE=live  # live or paper
      - VNC_SERVER_PASSWORD=${VNC_PASSWORD:-changeme}
      - TIME_ZONE=America/New_York
      - READ_ONLY_API=no
      - TWOFA_TIMEOUT_ACTION=restart  # Auto-restart on 2FA timeout
    ports:
      - "127.0.0.1:4001:4003"  # Host 4001 → Container 4003 (live trading API)
      - "127.0.0.1:4002:4004"  # Host 4002 → Container 4004 (paper trading API)
      - "127.0.0.1:5900:5900"  # VNC for remote desktop access
    volumes:
      - gateway-settings:/root/Jts
    healthcheck:
      # CRITICAL: Check if IB Gateway has completed authentication
      # Port opens BEFORE MFA completes, so we check logs instead
      test: ["CMD-SHELL", "grep -q 'Login has completed' /root/Jts/*/launcher.log 2>/dev/null || exit 1"]
      interval: 10s      # Check every 10 seconds
      timeout: 5s        # Fail if check takes >5s
      retries: 30        # Try 30 times (5 minutes) before marking unhealthy
      start_period: 180s # Allow 3 minutes for MFA approval before checking

  autoheal:
    image: willfarrell/autoheal:latest
    container_name: autoheal
    restart: unless-stopped
    environment:
      - AUTOHEAL_INTERVAL=10           # Check every 10 seconds
      - AUTOHEAL_START_PERIOD=180      # Wait 3 minutes before first check (MFA window)
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=10  # Stop timeout before restart
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

volumes:
  gateway-settings:
    driver: local
